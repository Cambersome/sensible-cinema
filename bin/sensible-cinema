#!/usr/bin/ruby
puts 'Welcome to Sensible Cinema...'

require 'rubygems'
require 'sane'
require_relative 'swing_helpers'
load File.dirname(__FILE__) +  '/sensible-cinema-cli'
require 'tmpdir'

module SensibleSwing
 class MainWindow < JFrame
   def initialize
     super "Sensible-Cinema"
     setDefaultCloseOperation JFrame::EXIT_ON_CLOSE
     panel = JPanel.new
     panel.set_layout nil
     setSize 350,400
     add panel # why can't I just slap these down?
 
     jlabel = JLabel.new 'Welcome to Sensible Cinema'
     happy = Font.new("Tahoma", Font::PLAIN, 11)
     jlabel.setFont(happy)
     jlabel.set_bounds(44,44,136,14)
     panel.add jlabel
     b = JButton.new( "Play Hulu, Youtube, or a DVD" ).on_clicked {
      self.close
      go_sc
     }
     b.set_bounds(44,120,200,23)
     panel.add b
    
     c=JButton.new( "Save local copy of an edited DVD" )
     c.on_clicked {
      fc = JFileChooser.new 
      fc.set_dialog_title "Please pick a directory within your DVD drive, like AUDIO_TS"
       
      fc.setCurrentDirectory(JFile.new("d:\\")) # it has a sensible default if you don't do this
      fc.setFileSelectionMode(JFileChooser::DIRECTORIES_ONLY)

      success = fc.show_open_dialog(nil)
      exit_and_close unless success == Java::javax::swing::JFileChooser::APPROVE_OPTION
      drive = fc.get_selected_file.get_absolute_path[0..2]
      fc.setFileSelectionMode(nil)
      fc.set_dialog_title "Please pick a DVD descriptor file"
      fc.set_current_directory(JFile.new( __dir__  + "/../zamples/scene_lists/dvds"))
      success = fc.show_open_dialog nil
      exit_and_close unless success == Java::javax::swing::JFileChooser::APPROVE_OPTION
      descriptor = fc.get_selected_file.get_absolute_path
      fc = JFileChooser.new 
      fc.set_dialog_title "Pick a location to save it to (like 'my_dvd')"
      # TODO allow for spaces
      fc.setCurrentDirectory(JFile.new("c:\\"))
      success = fc.show_save_dialog nil
      exit_and_close unless success == Java::javax::swing::JFileChooser::APPROVE_OPTION
      save_to = fc.get_selected_file.get_absolute_path
      p [drive, descriptor, save_to]
      descriptors = YAML.load_file descriptor
      bat_file = VLCProgrammer.convert_to_full_xspf(descriptors, save_to, drive)
      temp_dir = Dir.tmpdir
      temp_file = temp_dir + '/' + 'convert_it.bat'
      File.write(temp_file, bat_file)
      p 'running', temp_file
      JOptionPane.showMessageDialog(nil, "Processing", " Processing DVD to disk...this could take awhile", nil)
      system(temp_file)
      JOptionPane.showMessageDialog(nil, "Done!", " Done--you may now watch file #{save_to}.ps in VLC player", nil)
      self.close
     }
     c.set_bounds(44,180,200,23)
     panel.add c     
   end
  
   def exit_and_close
    JOptionPane.showMessageDialog(nil, "exiting", "exiting", JOptionPane::ERROR_MESSAGE)
    close
    exit
   end
 end
end

SensibleSwing::MainWindow.new.set_visible true

puts 'Please see the Sensible Cinema window'